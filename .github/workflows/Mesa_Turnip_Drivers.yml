name: Mesa Turnip Drivers

on:
  workflow_dispatch:
  schedule:
    - cron: '0 4 * * 1'

permissions:
  contents: write

env:
  MESA_VERSION: main

jobs:
  build:
    name: Build Mesa Turnip for Winlator
    runs-on: ubuntu-latest
    timeout-minutes: 180

    steps:
      - name: Install build dependencies
        run: |
          # Enable source repositories
          sudo sed -i 's/^# deb-src/deb-src/' /etc/apt/sources.list
          sudo apt-get -yqq update
          
          # Install Mesa build dependencies
          sudo apt-get -yqq build-dep mesa || true
          
          # Install additional build tools
          sudo apt-get -yqq install --no-install-recommends \
            git ninja-build pkg-config python3-pip python3-setuptools python3-wheel \
            bison flex cmake zstd file curl wget ca-certificates \
            libdrm-dev libx11-dev libxext-dev libxdamage-dev libxcb-glx0-dev \
            libxcb-shm0-dev libx11-xcb-dev libxcb-dri2-0-dev libxcb-dri3-dev \
            libxcb-present-dev libxshmfence-dev libxxf86vm-dev libxrandr-dev \
            libelf-dev libwayland-dev wayland-protocols libwayland-egl-backend-dev \
            libvulkan-dev glslang-tools libzstd-dev libexpat1-dev
          
          # Remove old meson and install latest via pip
          sudo apt-get remove -y meson || true
          pip3 install --user meson
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Verify Meson version
        run: |
          meson --version
          which meson

      - name: Checkout Mesa from GitLab
        run: |
          git clone --depth 1 --branch ${{ env.MESA_VERSION }} \
            https://gitlab.freedesktop.org/mesa/mesa.git mesa
          cd mesa
          git submodule update --init --recursive

      - name: Get Mesa commit info
        id: mesa_info
        run: |
          cd mesa
          COMMIT=$(git rev-parse --short HEAD)
          DATE=$(git log -1 --format=%cd --date=format:'%Y%m%d')
          
          # Try to get version from VERSION file
          if [ -f "VERSION" ]; then
            OFFICIAL_VERSION=$(cat VERSION)
          else
            OFFICIAL_VERSION=$(git describe --tags --always 2>/dev/null || echo "$DATE-$COMMIT")
          fi
          
          echo "commit=$COMMIT" >> $GITHUB_OUTPUT
          echo "date=$DATE" >> $GITHUB_OUTPUT
          echo "version=${OFFICIAL_VERSION}" >> $GITHUB_OUTPUT
          echo "full_version=${DATE}-${COMMIT}" >> $GITHUB_OUTPUT

      - name: Configure Mesa for Winlator
        run: |
          cd mesa
          
          # Create Winlator prefix directory
          sudo mkdir -p /data/data/com.winlator/files/rootfs/usr
          sudo chmod 777 -R /data
          
          # Configure Mesa with Winlator-compatible settings
          meson setup builddir \
            --libdir=lib \
            -Dprefix=/data/data/com.winlator/files/rootfs/usr \
            -Dbuildtype=release \
            -Doptimization=3 \
            -Db_lto=true \
            -Dplatforms=x11 \
            -Degl-native-platform=x11 \
            -Dglx=dri \
            -Dglx-direct=true \
            -Dopengl=true \
            -Dgles1=enabled \
            -Dgles2=enabled \
            -Dglvnd=disabled \
            -Degl=enabled \
            -Dllvm=disabled \
            -Dshared-llvm=disabled \
            -Dshader-cache=enabled \
            -Dxlib-lease=enabled \
            -Dvulkan-beta=true \
            -Dgallium-drivers=zink,freedreno \
            -Dvulkan-drivers=freedreno \
            -Dfreedreno-kmds=msm,kgsl \
            -Dvideo-codecs=all \
            -Dgbm=enabled \
            -Dtools=drm-shim,freedreno

      - name: Build Mesa
        run: |
          cd mesa
          ninja -C builddir -j$(nproc)
          ninja -C builddir install

      - name: Create build info
        run: |
          cat > /data/data/com.winlator/files/rootfs/usr/mesa-build-info.txt << EOF
          Mesa Build Information for Winlator
          ====================================
          Version: ${{ steps.mesa_info.outputs.version }}
          Commit: ${{ steps.mesa_info.outputs.commit }}
          Build Date: ${{ steps.mesa_info.outputs.date }}
          Build Type: Release (Optimized with LTO)
          Target: aarch64 Winlator GlibC
          
          Drivers:
          - Gallium: zink, freedreno
          - Vulkan: freedreno (Turnip)
          - OpenGL: Enabled
          - OpenGL ES 1.x/2.x: Enabled
          - EGL: Enabled
          - GBM: Enabled
          
          Features:
          - GLX DRI: Enabled
          - Shader Cache: Enabled
          - Video Codecs: All
          - Freedreno KMDs: msm, kgsl
          EOF

      - name: Package WCP for Winlator
        id: package
        run: |
          VERSION="${{ steps.mesa_info.outputs.full_version }}"
          WCP_NAME="mesa-turnip-${VERSION}.wcp"
          
          mkdir -p Mesa_WCP artifacts
          
          # Copy all Mesa files
          cp -r /data/data/com.winlator/files/rootfs/usr/* Mesa_WCP/
          
          # Create profile.json for WCP
          cat > Mesa_WCP/profile.json <<JSON
          {
            "type": "Mesa",
            "versionName": "${VERSION}",
            "versionCode": $(date +%Y%m%d),
            "description": "Mesa Turnip + Zink for Winlator GlibC (commit ${{ steps.mesa_info.outputs.commit }})",
            "files": []
          }
          JSON
          
          # Create WCP package
          cd Mesa_WCP
          tar --zstd --format=gnu --owner=0 --group=0 --numeric-owner --sort=name \
              -cf "../artifacts/${WCP_NAME}" .
          
          echo "wcp_name=${WCP_NAME}" >> $GITHUB_OUTPUT
          
          cd ..
          ls -lh artifacts/

      - name: Create/Update Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          RELEASE_TAG="MESA-TURNIP"
          VERSION="${{ steps.mesa_info.outputs.full_version }}"
          
          cat > /tmp/notes.md <<EOF
          Mesa Turnip + Zink Drivers for Winlator GlibC
          
          **Mesa Version:** ${{ steps.mesa_info.outputs.version }}
          **Commit:** ${{ steps.mesa_info.outputs.commit }}
          **Build Date:** ${{ steps.mesa_info.outputs.date }}
          **Source:** https://gitlab.freedesktop.org/mesa/mesa
          
          **Drivers & Features:**
          - ✅ **Gallium Drivers:** zink, freedreno
          - ✅ **Vulkan Driver:** freedreno (Turnip)
          - ✅ **OpenGL:** Full support
          - ✅ **OpenGL ES:** 1.x and 2.x
          - ✅ **EGL:** Enabled
          - ✅ **GBM:** Enabled
          - ✅ **GLX DRI:** Direct rendering
          - ✅ **Shader Cache:** Enabled
          - ✅ **Video Codecs:** All supported
          - ✅ **Freedreno KMDs:** msm, kgsl (both)
          
          **Build Configuration:**
          - Release build with optimization level 3
          - LTO (Link Time Optimization) enabled
          - X11 platform support
          - LLVM disabled (not needed for ARM)
          
          **Installation (Winlator GlibC 7.1.2+):**
          1. Download the .wcp file
          2. In Winlator, open side menu → Contents
          3. Select "Turnip" or "Mesa" in dropdown
          4. Tap "Install Content" and select the .wcp file
          5. Restart container if needed
          
          **Credits:**
          - Mesa3D Team
          - afeimod (Winlator Mod build config)
          - Winlator community
          
          **Note:** This is a complete Mesa build with all necessary components for Winlator, not just Vulkan driver.
          EOF
          
          if ! gh release view "${RELEASE_TAG}" --repo "${{ github.repository }}" >/dev/null 2>&1; then
            gh release create "${RELEASE_TAG}" \
              --repo "${{ github.repository }}" \
              --title "Mesa Turnip + Zink Drivers" \
              --notes-file /tmp/notes.md
          else
            gh release edit "${RELEASE_TAG}" \
              --repo "${{ github.repository }}" \
              --notes-file /tmp/notes.md
          fi
          
          gh release upload "${RELEASE_TAG}" \
            "./artifacts/${{ steps.package.outputs.wcp_name }}" \
            --repo "${{ github.repository }}" \
            --clobber
