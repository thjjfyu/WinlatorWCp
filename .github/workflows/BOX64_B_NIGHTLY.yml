name: Box64-Bionic

on:
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * 1'

permissions:
  contents: write

env:
  NDK_VERSION: r26b
  LLVM_MINGW_VERSION: 20250305
  LLVM_MINGW_TAG: 20250305-ucrt-ubuntu-20.04-x86_64
  LLVM_MINGW_BASE: llvm-mingw-20250305-ucrt-ubuntu-20.04-x86_64

jobs:
  build:
    name: Build Box64
    runs-on: ubuntu-latest
    timeout-minutes: 60

    strategy:
      fail-fast: false
      matrix:
        arch: [arm64]
        variant: [bionic]
        api_level: [28]

    steps:
      - name: Install system dependencies
        run: |
          sudo apt-get -yqq update
          sudo apt-get -yqq install --no-install-recommends \
            git cmake make ninja-build python3 python3-pip zstd file curl unzip ca-certificates binutils

      - name: Checkout Box64
        uses: actions/checkout@v4
        with:
          repository: ptitSeb/box64
          ref: main
          submodules: recursive
          path: box64
          fetch-depth: 0

      - name: Get Box64 commit info
        id: box64_info
        run: |
          cd box64
          COMMIT=$(git rev-parse --short HEAD)
          DATE=$(git log -1 --format=%cd --date=format:'%Y%m%d')
          echo "commit=$COMMIT" >> $GITHUB_OUTPUT
          echo "date=$DATE" >> $GITHUB_OUTPUT
          echo "version=${DATE}-${COMMIT}" >> $GITHUB_OUTPUT

      - name: Download Android NDK
        run: |
          NDK_BASE="android-ndk-${NDK_VERSION}"
          NDK_URL="https://dl.google.com/android/repository/${NDK_BASE}-linux.zip"
          
          curl -fsSL -o ndk.zip "$NDK_URL"
          unzip -q ndk.zip
          
          echo "NDK=$PWD/${NDK_BASE}" >> $GITHUB_ENV
          echo "BOX64_COMPILER=$PWD/${NDK_BASE}/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android${{ matrix.api_level }}-clang" >> $GITHUB_ENV

      - name: Apply Box64 patches
        run: |
          cd box64
          
          # Revert problematic format fix
          cat > /tmp/revert_format.patch <<'EOF'
          diff --git a/src/wrapped/wrappedlibc.c b/src/wrapped/wrappedlibc.c
          index abcdef..123456 100644
          --- a/src/wrapped/wrappedlibc.c
          +++ b/src/wrapped/wrappedlibc.c
          @@ -1234,7 +1234,7 @@
           #ifdef ANDROID
               char buff[4096];
               vsnprintf(buff, 4096, fmt, b);
          -    __android_log_print(ANDROID_LOG_INFO, "Box64", "%s", buff);
          +    __android_log_print(ANDROID_LOG_INFO, "Box64", buff);
           #else
               vprintf(fmt, b);
           #endif
          EOF
          
          git apply /tmp/revert_format.patch || echo "Patch already applied or not needed"

      - name: Configure CMake
        run: |
          cd box64
          mkdir -p build && cd build
          
          cmake .. \
            -G Ninja \
            -DCMAKE_C_COMPILER="${BOX64_COMPILER}" \
            -DANDROID=1 \
            -DARM_DYNAREC=1 \
            -DBAD_SIGNAL=1 \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_VERBOSE_MAKEFILE:BOOL=ON \
            -DZYDIS3=0 \
            -DSTATICBUILD=0 \
            -DBOX32=0

      - name: Build Box64
        run: cmake --build box64/build -j$(nproc)

      - name: Strip binary
        run: |
          BIN="box64/build/box64"
          STRIP="${NDK}/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-strip"
          
          if [[ -x "$STRIP" ]]; then
            "$STRIP" --strip-unneeded "$BIN"
          else
            strip --strip-unneeded "$BIN"
          fi
          
          file "$BIN"
          echo "Size: $(ls -lh $BIN | awk '{print $5}')"

      - name: Verify Android binary
        run: |
          echo "=== INTERPRETER ==="
          readelf -lW box64/build/box64 | grep interpreter || true
          echo "=== NEEDED LIBS ==="
          readelf -d box64/build/box64 | grep NEEDED || true

      - name: Package WCP
        id: package
        run: |
          VERSION="${{ steps.box64_info.outputs.version }}"
          WCP_NAME="box64-${{ matrix.variant }}-${VERSION}.wcp"
          
          mkdir -p Box64_WCP artifacts
          cp box64/build/box64 Box64_WCP/box64
          chmod +x Box64_WCP/box64
          
          cat > Box64_WCP/profile.json <<JSON
          {
            "type": "Box64",
            "versionName": "${VERSION}",
            "versionCode": $(date +%Y%m%d),
            "description": "Box64 ${{ matrix.variant }} (commit ${{ steps.box64_info.outputs.commit }})",
            "files": [
              { "source": "box64", "target": "\${bindir}/box64" }
            ]
          }
          JSON
          
          cd Box64_WCP
          tar --zstd --format=gnu --owner=0 --group=0 --numeric-owner --sort=name \
              -cf "../artifacts/${WCP_NAME}" profile.json box64
          
          echo "wcp_name=${WCP_NAME}" >> $GITHUB_OUTPUT

      - name: Create/Update Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          RELEASE_TAG="BOX64-BIONIC-NIGHTLY"
          VERSION="${{ steps.box64_info.outputs.version }}"
          
          cat > /tmp/notes.md <<EOF
          Box64 Bionic Build
          
          **Commit:** ${{ steps.box64_info.outputs.commit }}
          **Date:** ${{ steps.box64_info.outputs.date }}
          **Variant:** ${{ matrix.variant }}
          **API Level:** ${{ matrix.api_level }}
          
          **Build details:**
          - Android NDK: ${NDK_VERSION}
          - Bionic libc
          - ARM64 Dynarec enabled
          - Static build: No
          EOF
          
          if ! gh release view "${RELEASE_TAG}" --repo "${{ github.repository }}" >/dev/null 2>&1; then
            gh release create "${RELEASE_TAG}" \
              --repo "${{ github.repository }}" \
              --title "Box64 Bionic" \
              --notes-file /tmp/notes.md
          else
            gh release edit "${RELEASE_TAG}" \
              --repo "${{ github.repository }}" \
              --notes-file /tmp/notes.md
          fi
          
          gh release upload "${RELEASE_TAG}" \
            "./artifacts/${{ steps.package.outputs.wcp_name }}" \
            --repo "${{ github.repository }}" \
            --clobber
