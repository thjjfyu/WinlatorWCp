name: FEXCore Last commit

on:
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * 1'

permissions:
  contents: write

env:
  LLVM_MINGW_VERSION: 20250920
  LLVM_MINGW_TAG: 20250920-ucrt-ubuntu-20.04-x86_64
  LLVM_MINGW_BASE: llvm-mingw-20250920-ucrt-ubuntu-20.04-x86_64

jobs:
  build:
    name: Build FEXCore
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
      - name: Install build dependencies
        run: |
          sudo apt-get -yqq update
          sudo apt-get -yqq install --no-install-recommends \
            git cmake make ninja-build python3 python3-pip zstd file curl unzip ca-certificates \
            binutils clang lld

      - name: Checkout FEX
        uses: actions/checkout@v4
        with:
          repository: FEX-Emu/FEX
          ref: main
          submodules: recursive
          path: FEX
          fetch-depth: 0

      - name: Get FEX commit info
        id: fex_info
        run: |
          cd FEX
          COMMIT=$(git rev-parse --short HEAD)
          DATE=$(git log -1 --format=%cd --date=format:'%Y%m%d')
          echo "commit=$COMMIT" >> $GITHUB_OUTPUT
          echo "date=$DATE" >> $GITHUB_OUTPUT
          echo "version=${DATE}-${COMMIT}" >> $GITHUB_OUTPUT

      - name: Download LLVM-MinGW
        run: |
          LLVM_URL="https://github.com/mstorsjo/llvm-mingw/releases/download/${LLVM_MINGW_VERSION}/${LLVM_MINGW_BASE}.tar.xz"
          
          curl -fsSL -o llvm-mingw.tar.xz "$LLVM_URL"
          tar -xf llvm-mingw.tar.xz
          
          echo "LLVM_MINGW_PATH=$PWD/${LLVM_MINGW_BASE}" >> $GITHUB_ENV

      - name: Configure CMake
        run: |
          cd FEX
          mkdir -p build && cd build
          
          cmake .. \
            -G Ninja \
            -DCMAKE_TOOLCHAIN_FILE=../toolchain_mingw.cmake \
            -DMINGW_TRIPLE=aarch64-w64-mingw32 \
            -DENABLE_LTO=True \
            -DBUILD_TESTS=False \
            -DENABLE_ASSERTIONS=False \
            -DCMAKE_BUILD_TYPE=Release

      - name: Build FEXCore
        run: cmake --build FEX/build -j$(nproc)

      - name: Strip binaries
        run: |
          cd FEX/build
          find . -name "*.exe" -o -name "*.dll" | while read f; do
            ${LLVM_MINGW_PATH}/bin/llvm-strip --strip-unneeded "$f" || true
          done

      - name: Package WCP
        id: package
        run: |
          VERSION="${{ steps.fex_info.outputs.version }}"
          WCP_NAME="fexcore-${VERSION}.wcp"
          
          mkdir -p FEXCore_WCP artifacts
          
          # Copy binaries
          cp FEX/build/Bin/FEXInterpreter.exe FEXCore_WCP/
          cp FEX/build/Bin/*.dll FEXCore_WCP/ || true
          
          cat > FEXCore_WCP/profile.json <<JSON
          {
            "type": "FEXCore",
            "versionName": "${VERSION}",
            "versionCode": $(date +%Y%m%d),
            "description": "FEXCore (commit ${{ steps.fex_info.outputs.commit }})",
            "files": [
              { "source": "FEXInterpreter.exe", "target": "\${bindir}/FEXInterpreter.exe" }
            ]
          }
          JSON
          
          cd FEXCore_WCP
          tar --zstd --format=gnu --owner=0 --group=0 --numeric-owner --sort=name \
              -cf "../artifacts/${WCP_NAME}" profile.json *
          
          echo "wcp_name=${WCP_NAME}" >> $GITHUB_OUTPUT

      - name: Create/Update Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          RELEASE_TAG="FEXCore-Nightly"
          
          cat > /tmp/notes.md <<EOF
          FEXCore Build
          
          **Commit:** ${{ steps.fex_info.outputs.commit }}
          **Date:** ${{ steps.fex_info.outputs.date }}
          
          **Build details:**
          - LLVM-MinGW: ${LLVM_MINGW_VERSION}
          - LTO: Enabled
          - Assertions: Disabled
          EOF
          
          if ! gh release view "${RELEASE_TAG}" --repo "${{ github.repository }}" >/dev/null 2>&1; then
            gh release create "${RELEASE_TAG}" \
              --repo "${{ github.repository }}" \
              --title "FEXCore Last commit" \
              --notes-file /tmp/notes.md
          else
            gh release edit "${RELEASE_TAG}" \
              --repo "${{ github.repository }}" \
              --notes-file /tmp/notes.md
          fi
          
          gh release upload "${RELEASE_TAG}" \
            "./artifacts/${{ steps.package.outputs.wcp_name }}" \
            --repo "${{ github.repository }}" \
            --clobber
